<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Quiz dos Personagens</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #3b0a45;
      color: #fff;
      text-align: center;
    }
    .login, .game, .results, .adminPanel, .countdownOverlay, .finalWindow {
      display: none;
    }
    .active {
      display: block;
    }
    .login {
      margin-top: 100px;
    }
    input, button {
      padding: 10px;
      margin: 10px;
      border-radius: 8px;
      border: none;
    }
    .error { background-color: #ff4d4d; }
    .success { background-color: #4CAF50; }
    #timer { position: absolute; top: 10px; left: 10px; font-size: 40px; }
    #score { font-size: 24px; margin: 10px; }
    #podio div:nth-child(1) { background: gold; }
    #podio div:nth-child(2) { background: silver; }
    #podio div:nth-child(3) { background: #cd7f32; }
    .countdownOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: black;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 100px;
    }
    .finalWindow {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 20px;
    }
    footer { margin-top: 20px; padding: 20px; background: #2b0832; }
  </style>
</head>
<body>
  <div class="login active">
    <h1>Outubro Macabro: 31 Dias de Mistério e Sabor</h1>
    <h2>Quiz dos personagens</h2>
    <input type="text" id="nickname" placeholder="Digite seu nick">
    <button onclick="login()">Entrar</button>
    <p id="loginMsg"></p>
  </div>

  <div class="countdownOverlay" id="countdown"></div>

  <div class="game">
    <div id="timer">30</div>
    <div id="score">Pontos: 0</div>
    <img id="characterImg" src="" width="200"><br>
    <input type="text" id="answer" placeholder="Quem é?">
    <button onclick="checkAnswer()">Responder</button>
  </div>

  <div class="results">
    <h2>Resultado</h2>
    <div id="userResult"></div>
    <h3>Pódio</h3>
    <div id="podio"></div>
  </div>

  <div class="adminPanel">
    <h2>Painel Admin</h2>
    <div id="adminResults"></div>
    <button onclick="resetAll()">Reboot</button>
  </div>

  <div class="finalWindow" id="finalWindow">
    <div id="finalInfo"></div>
    <button onclick="saveFinalResult()">Salvar resultado</button>
  </div>

  <footer>Feito por: luis</footer>

  <audio id="soundCorrect">
    <source src="https://www.soundjay.com/buttons/sounds/button-3.mp3" type="audio/mpeg">
  </audio>
  <audio id="soundWrong">
    <source src="https://www.soundjay.com/buttons/sounds/button-10.mp3" type="audio/mpeg">
  </audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCh5arCVwjcDWKM6GZd5pAmhJlozRhCg1w",
    authDomain: "jogos-de-halloween.firebaseapp.com",
    projectId: "jogos-de-halloween",
    storageBucket: "jogos-de-halloween.appspot.com",
    messagingSenderId: "431194437451",
    appId: "1:431194437451:web:c55bef0f224d37ad135ace",
    measurementId: "G-WWMMPG8EX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentUser = null;
  let currentScore = 0;
  let currentCharacterIndex = 0;
  let timerInterval;
  let timeLeft = 30;
  let startTime;
  let elapsedTime;

  const characters = [
    { name: "chuck", img: "https://i.imgur.com/6XKMp7Y.png" },
    { name: "drácula", img: "https://i.imgur.com/aeRFyCr.png" },
    { name: "freddy krueger", img: "https://i.imgur.com/RyQgov7.png" },
    { name: "pennywise", img: "https://i.imgur.com/MdF3VWu.png" },
    { name: "frankenstein", img: "https://i.imgur.com/1TpY4md.png" },
    { name: "jason", img: "https://i.imgur.com/UPotXXO.png" },
    { name: "lobisomem", img: "https://i.imgur.com/kB6ydUP.png" },
    { name: "annabelle", img: "https://i.imgur.com/gHdIHHd.png" },
    { name: "michael myers", img: "https://i.imgur.com/7feqzEE.png" },
    { name: "jack skellington", img: "https://i.imgur.com/lxdb9oT.png" }
  ];

  async function login() {
    const nick = document.getElementById('nickname').value.trim().toLowerCase();
    if (!nick) return;

    if (nick === 'admin123') {
      const senha = prompt('Digite a senha de admin:');
      if (senha === '123456') {
        document.querySelector('.login').classList.remove('active');
        document.querySelector('.adminPanel').classList.add('active');
        loadAdmin();
      }
      return;
    }

    const query = await getDocs(collection(db, "results"));
    let used = false;
    query.forEach(doc => { if (doc.data().nick === nick) used = true; });

    if (used) {
      document.getElementById('loginMsg').innerHTML = "Só é permitido jogar apenas uma vez!";
      return;
    }

    currentUser = nick;
    document.querySelector('.login').classList.remove('active');
    startCountdown();
  }

  function startCountdown() {
    let count = 5;
    const overlay = document.getElementById('countdown');
    overlay.classList.add('active');
    overlay.innerText = count;
    const interval = setInterval(() => {
      count--;
      if (count > 0) {
        overlay.innerText = count;
      } else if (count === 0) {
        overlay.innerText = 'Valendo!';
      } else {
        clearInterval(interval);
        overlay.classList.remove('active');
        startGame();
      }
    }, 1000);
  }

  function startGame() {
    document.querySelector('.game').classList.add('active');
    loadCharacter();
    startTime = new Date();
    timerInterval = setInterval(() => {
      timeLeft--;
      document.getElementById('timer').innerText = timeLeft;
      if (timeLeft <= 0) {
        nextCharacter();
      }
    }, 1000);
  }

  function loadCharacter() {
    timeLeft = 30;
    document.getElementById('timer').innerText = timeLeft;
    document.getElementById('characterImg').src = characters[currentCharacterIndex].img;
    document.getElementById('answer').value = '';
  }

  function checkAnswer() {
    const ans = document.getElementById('answer').value.trim().toLowerCase();
    const expected = characters[currentCharacterIndex].name;
    if (ans === expected) {
      currentScore += 10;
      document.getElementById('score').innerText = "Pontos: " + currentScore;
      document.getElementById('answer').classList.remove('error');
      document.getElementById('answer').classList.add('success');
      document.getElementById('soundCorrect').play();
      nextCharacter();
    } else {
      document.getElementById('answer').classList.add('error');
      document.getElementById('soundWrong').play();
    }
  }

  function nextCharacter() {
    currentCharacterIndex++;
    if (currentCharacterIndex < characters.length) {
      loadCharacter();
    } else {
      finishGame();
    }
  }

  function finishGame() {
    clearInterval(timerInterval);
    const endTime = new Date();
    elapsedTime = Math.floor((endTime - startTime) / 1000);
    const info = `Nick: ${currentUser}<br>Pontos: ${currentScore}<br>Tempo: ${elapsedTime}s<br>Data/Hora: ${endTime.toLocaleString()}`;
    document.getElementById('finalInfo').innerHTML = info;
    document.getElementById('finalWindow').classList.add('active');
  }

  async function saveFinalResult() {
    const now = new Date();
    await addDoc(collection(db, "results"), {
      nick: currentUser,
      pontos: currentScore,
      tempo: elapsedTime,
      data: now.toLocaleString()
    });
    document.getElementById('finalWindow').classList.remove('active');
    document.querySelector('.game').classList.remove('active');
    document.querySelector('.results').classList.add('active');
    loadResults(currentUser);
  }

  async function loadResults(user) {
    const query = await getDocs(collection(db, "results"));
    let results = [];
    query.forEach(doc => results.push(doc.data()));
    results.sort((a, b) => b.pontos - a.pontos || new Date(a.data) - new Date(b.data));

    const podio = document.getElementById('podio');
    podio.innerHTML = '';
    results.slice(0, 3).forEach((r, i) => {
      const div = document.createElement('div');
      div.innerText = `${i+1}º ${r.nick} - ${r.pontos} pontos`;
      podio.appendChild(div);
    });

    const userRes = results.find(r => r.nick === user);
    if(userRes){
      document.getElementById('userResult').innerText = `Nick: ${userRes.nick}, Pontos: ${userRes.pontos}, Tempo: ${userRes.tempo}s, Data: ${userRes.data}`;
    }
  }

  async function loadAdmin() {
    const query = await getDocs(collection(db, "results"));
    const container = document.getElementById('adminResults');
    container.innerHTML = '';
    let i = 1;
    query.forEach(d => {
      const r = d.data();
      const row = document.createElement('div');
      row.innerHTML = `${i++} - ${r.nick} | ${r.pontos} pontos | ${r.tempo}s | ${r.data}
        <button onclick="deleteResult('${d.id}')">Deletar</button>
        <button onclick="editResult('${d.id}')">Editar</button>`;
      container.appendChild(row);
    });
  }

  async function resetAll() {
    const query = await getDocs(collection(db, "results"));
    query.forEach(async d => {
      await deleteDoc(doc(db, "results", d.id));
    });
    loadAdmin();
  }

  window.deleteResult = async function(id) {
    await deleteDoc(doc(db, "results", id));
    loadAdmin();
  }

  window.editResult = async function(id) {
    const newScore = prompt('Novo score:');
    await updateDoc(doc(db, "results", id), { pontos: parseInt(newScore) });
    loadAdmin();
  }
</script>
</body>
</html>
