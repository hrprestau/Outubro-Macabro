<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Outubro Macabro: Quiz dos personagens</title>
  <!-- Favicon -->
  <link rel="icon" href="https://i.imgur.com/dAS8n5c.png" type="image/png">
  <style>
    :root{--bg1:#2b0b3a;--bg2:#4b1060;--accent:#ff7a00}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;min-height:100vh;display:flex;align-items:stretch;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff}
    .container{width:100%;max-width:1100px;margin:40px auto;padding:20px}
    header{display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:18px;text-align:center}
    h1{font-size:28px;margin:0;color:var(--accent)}
    h2{margin:0;font-size:18px;opacity:0.95}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border-radius:12px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,0.4)}
    #loginView{max-width:600px;margin:0 auto}
    label{display:block;margin-bottom:8px;font-weight:600}
    input[type=text], input[type=password]{width:100%;padding:12px;border-radius:8px;border:2px solid rgba(255,255,255,0.08);background:transparent;color:#fff;font-size:16px}
    .btn{display:inline-block;padding:10px 16px;border-radius:8px;background:var(--accent);color:#1a0b00;font-weight:700;border:none;cursor:pointer}
    .muted{opacity:0.85}
    #gameView{display:none}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .timer{font-weight:800;font-size:36px;background:rgba(0,0,0,0.25);padding:8px 12px;border-radius:10px}
    .score{font-size:18px}
    .stage{display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:8px}
    .characterCard{width:360px;height:360px;border-radius:12px;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .characterCard img{max-width:100%;max-height:100%;object-fit:contain}
    .answerBox{margin-top:14px;display:flex;gap:10px;align-items:center}
    .answerBox input{flex:1;padding:12px;border-radius:10px;border:2px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:#fff;font-size:16px}
    .answerBox input.wrong{border-color:#ff4b4b;background:rgba(255,75,75,0.06);animation:shake .3s}
    @keyframes shake{0%{transform:translateX(-3px)}50%{transform:translateX(3px)}100%{transform:translateX(0)}}
    .countdownBig{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;font-size:96px;font-weight:900;color:var(--accent);pointer-events:none;z-index:1500}
    .smallNote{font-size:12px;opacity:0.9}
    #resultsView{display:none}
    /* Podium layout centered and with elevation differences */
.podium {
  display: flex;
  gap: 18px;
  align-items: flex-end;
  justify-content: center;
  margin: 20px 0;
  perspective: 800px;
}

.podium .place {
  width: 160px;
  text-align: center;
  padding: 14px;
  border-radius: 10px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  transform-origin: center bottom;
  box-shadow: 0 8px 25px rgba(0,0,0,0.5);
  transition: transform 0.28s ease, box-shadow 0.28s ease;
  color: #fff;
  font-weight: 800;
  text-shadow: 2px 2px 4px #000;
}

.first {
  height: 200px;
  background: linear-gradient(180deg, #D4AF37, #E6C85C);
  transform: translateY(-12px);
}

.second {
  height: 160px;
  background: linear-gradient(180deg, #C0C0C0, #D7D7D7);
  transform: translateY(0px);
}

.third {
  height: 140px;
  background: linear-gradient(180deg, #CD7F32, #D99663);
  transform: translateY(2px);
}

/* highlight animation for champion */
.first .championInner {
  position: relative;
  padding-top: 8px;
}

.first::after {
  content: '';
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 100%;
  width: 140%;
  height: 40px;
  background: radial-gradient(ellipse at center, rgba(255,255,200,0.28), rgba(255,255,200,0.06) 40%, transparent 60%);
  filter: blur(8px);
  opacity: 0.9;
  pointer-events: none;
}

.first:hover {
  transform: translateY(-16px) scale(1.03);
  box-shadow: 0 14px 40px rgba(0,0,0,0.6);
}

.second:hover,
.third:hover {
  transform: translateY(-6px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.55);
}

/* Labels */
.podium .place div {
  color: #fff;
  font-weight: 800;
  text-shadow: 2px 2px 4px #000;
}
    /* updated colors */
    .first{height:190px;background:linear-gradient(180deg,#D4AF37,#E6C85C);color:#231900; transform: translateY(-12px); }
    .second{height:150px;background:linear-gradient(180deg,#C0C0C0,#D7D7D7);color:#0b0b0b; transform: translateY(0px); }
    .third{height:130px;background:linear-gradient(180deg,#CD7F32,#D99663);color:#2b0b00; transform: translateY(2px); }
    /* highlight animation for champion */
    .first .championInner{position:relative; padding-top:8px;}
    .first::after{
      content:'';
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:100%;
      width:140%;
      height:40px;
      background:radial-gradient(ellipse at center, rgba(255,255,200,0.28), rgba(255,255,200,0.06) 40%, transparent 60%);
      filter: blur(8px);
      opacity:0.9;
      pointer-events:none;
    }
    .first:hover{ transform: translateY(-16px) scale(1.03); box-shadow: 0 14px 40px rgba(0,0,0,0.6); }
    .second:hover, .third:hover{ transform: translateY(-6px); box-shadow: 0 10px 30px rgba(0,0,0,0.55); }
    .listings{margin-top:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
    footer{margin-top:26px;text-align:center;opacity:0.85}
    .admin-panel{margin-top:12px}
    .admin-actions{display:flex;gap:8px;flex-wrap:wrap}
    @media (max-width:700px){.characterCard{width:90vw;height:60vw}.timer{font-size:28px}.countdownBig{font-size:64px}.podium .place{width:26vw}}
    /* Blur during countdown */
    .countdown-blur .container { filter: blur(6px) saturate(0.9); transition: filter 0.25s ease; -webkit-filter: blur(6px) saturate(0.9); }
    /* Modal for save results */
    #saveModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      background: rgba(0,0,0,0.5);
    }
    #saveModal .modalCard {
      width: 92%;
      max-width: 520px;
      border-radius: 12px;
      padding: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      color: #fff;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    }
    #saveModal .modalCard h3{margin:0 0 8px 0}
    #saveModal .modalCard .meta{margin:8px 0;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)}
    #saveModal .modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Outubro Macabro: 31 Dias de Mistério e Sabor</h1>
      <h2>Quiz dos personagens</h2>
    </header>

    <!-- LOGIN -->
    <div id="loginView" class="card">
      <p class="muted">Escolha um nick para jogar. Cada nick só pode jogar uma vez.</p>
      <label for="nickInput">Nick</label>
      <input type="text" id="nickInput" placeholder="Seu apelido..." autocomplete="off" />
      <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
        <button id="startBtn" class="btn">Iniciar Quiz</button>
        <button id="viewResultsBtn" class="btn" style="background:#6b2b8a;color:#fff">Ver Pódio</button>
      </div>
      <p id="loginMsg" style="margin-top:12px;color:#ffcccb;display:none;font-weight:700"></p>
    </div>

    <!-- GAME -->
    <div id="gameView" class="card">
      <div class="topbar">
        <div class="timer" id="questionTimer">30</div>
        <div class="score">Nick: <span id="nickBadge"></span> &nbsp;|&nbsp; Pontos: <strong id="score">0</strong></div>
      </div>

      <div class="stage">
        <div class="characterCard" id="charCard"><img id="charImg" src="" alt="personagem"/></div>
        <div class="answerBox">
          <input id="answerInput" type="text" placeholder="Quem é esse personagem?" autocomplete="off" />
          <button id="submitAnswer" class="btn">Responder</button>
        </div>
        <div class="smallNote">Você tem <strong>30s</strong> por personagem. Acerta = +10 pontos.</div>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="resultsView" class="card">
      <div id="userResultBox" style="margin-bottom:12px;padding:12px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:none"></div>

      <h3 style="margin-top:6px">Pódio</h3>
      <div class="podium" id="podiumContainer"></div>

      <h3>Todos os envios (ordem de envio)</h3>
      <div class="listings">
        <table><thead><tr><th>#</th><th>Nick</th><th>Pontos</th><th>Tempo (s)</th><th>Data / Hora</th><th>Ações</th></tr></thead><tbody id="allSubmissions"></tbody></table>
      </div>

      <div id="adminArea" style="display:none" class="admin-panel card">
        <h3>Admin - Painel</h3>
        <div class="admin-actions" style="margin-bottom:10px">
          <button id="adminReboot" class="btn" style="background:#b31b1b">Reboot (Apagar todos)</button>
          <button id="adminViewPodium" class="btn" style="background:#6b2b8a">Ver Pódio</button>
        </div>
        <div style="font-size:13px;opacity:0.9">Ações administrativas: deletar, editar cada envio. Use com cuidado.</div>
      </div>
    </div>

    <footer>Feito por: luis</footer>
  </div>

  <div id="countdownBig" class="countdownBig" style="display:none"></div>

  <!-- Modal para salvar resultado -->
  <div id="saveModal">
    <div class="modalCard">
      <h3>Resultado concluído</h3>
      <div class="meta" id="modalMeta">
        <!-- preenchido dinamicamente -->
      </div>
      <div class="modalActions">
        <button id="cancelSaveBtn" class="btn" style="background:#666;color:#fff">Fechar</button>
        <button id="confirmSaveBtn" class="btn">Salvar Resultado</button>
      </div>
    </div>
  </div>

  <!-- audio elements (src set via JS as base64 data URIs) -->
  <audio id="negativeSound" preload="auto"></audio>
  <audio id="positiveSound" preload="auto"></audio>

  <!-- Firebase SDK (modular) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, updateDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // --- Firebase config (da sua imagem) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCh5arCVwjcDWKM6GZd5pAmhjlozRhCg1w",
      authDomain: "jogos-de-halloween.firebaseapp.com",
      projectId: "jogos-de-halloween",
      storageBucket: "jogos-de-halloween.appspot.com",
      messagingSenderId: "431194437451",
      appId: "1:431194437451:web:c55bef0f224d37ad135ace",
      measurementId: "G-WMW0MPG8EX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Characters ---
    const characters = [
      {name:'chuck', url:'https://i.imgur.com/6XKMp7Y.png'},
      {name:'Drácula', url:'https://i.imgur.com/aeRFyCr.png'},
      {name:'Freddy Krueger', url:'https://i.imgur.com/RyQgov7.png'},
      {name:'Pennywise', url:'https://i.imgur.com/MdF3VWu.png'},
      {name:'Frankenstein', url:'https://i.imgur.com/1TpY4md.png'},
      {name:'Jason', url:'https://i.imgur.com/UPotXXO.png'},
      {name:'Lobisomem', url:'https://i.imgur.com/kB6ydUP.png'},
      {name:'Annabelle', url:'https://i.imgur.com/gHdIHHd.png'},
      {name:'Michael Myers', url:'https://i.imgur.com/7feqzEE.png'},
      {name:'Jack Skellington', url:'https://i.imgur.com/lxdb9oT.png'}
    ];

    // DOM
    const loginView = document.getElementById('loginView');
    const gameView = document.getElementById('gameView');
    const resultsView = document.getElementById('resultsView');
    const nickInput = document.getElementById('nickInput');
    const startBtn = document.getElementById('startBtn');
    const viewResultsBtn = document.getElementById('viewResultsBtn');
    const loginMsg = document.getElementById('loginMsg');
    const nickBadge = document.getElementById('nickBadge');

    const charImg = document.getElementById('charImg');
    const questionTimerEl = document.getElementById('questionTimer');
    const answerInput = document.getElementById('answerInput');
    const submitAnswer = document.getElementById('submitAnswer');
    const scoreEl = document.getElementById('score');

    const countdownBig = document.getElementById('countdownBig');
    const negativeSoundEl = document.getElementById('negativeSound');
    const positiveSoundEl = document.getElementById('positiveSound');

    const podiumContainer = document.getElementById('podiumContainer');
    const allSubmissionsTbody = document.getElementById('allSubmissions');
    const userResultBox = document.getElementById('userResultBox');
    const adminArea = document.getElementById('adminArea');
    const adminRebootBtn = document.getElementById('adminReboot');
    const adminViewPodiumBtn = document.getElementById('adminViewPodium');

    const saveModal = document.getElementById('saveModal');
    const modalMeta = document.getElementById('modalMeta');
    const confirmSaveBtn = document.getElementById('confirmSaveBtn');
    const cancelSaveBtn = document.getElementById('cancelSaveBtn');

    // State
    let shuffled = [];
    let currentIndex = 0;
    let perQuestionTimer = null;
    let perQuestionRemaining = 30;
    let score = 0;
    let currentUser = null;
    let gameStartTs = null;
    let gameEndTs = null;
    let pendingSubmission = null; // holds submission until user clicks "Salvar Resultado"
    let isAdmin = false; // controla se o usuário atual é admin

    const SUBMISSIONS_COLLECTION = 'submissions';

    // small beep fallback (in case audio/datauri playback blocked)
    function mkBeep(freq, dur){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type='sine'; o.frequency.value=freq; g.gain.value=0.05;
        o.connect(g); g.connect(ctx.destination);
        o.start(); o.stop(ctx.currentTime + dur/1000);
        return;
      }catch(e){}
    }

    // helper text functions
    function normalizeAnswer(s){ if(!s) return ''; return s.toLowerCase().trim().normalize('NFD').replace(/\p{Diacritic}/gu, ''); }
    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }
    function formatDateTime(d){ return d.toLocaleString('pt-BR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}) }

    // AUDIO: create small WAV data URIs (base64) dynamically
    // returns base64 string for a mono 16-bit PCM WAV
    function makeWavBase64(freqs, durationSec, sampleRate=44100, gain=0.7){
      // freqs: array of frequency numbers (to mix) or a single freq
      if(!Array.isArray(freqs)) freqs = [freqs];
      const sampleCount = Math.floor(sampleRate * durationSec);
      const buffer = new ArrayBuffer(44 + sampleCount * 2);
      const view = new DataView(buffer);

      // WAV header
      function writeString(view, offset, str){
        for(let i=0;i<str.length;i++) view.setUint8(offset+i, str.charCodeAt(i));
      }
      writeString(view, 0, 'RIFF');
      view.setUint32(4, 36 + sampleCount * 2, true);
      writeString(view, 8, 'WAVE');
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true); // PCM chunk size
      view.setUint16(20, 1, true); // audio format = PCM
      view.setUint16(22, 1, true); // channels = 1
      view.setUint32(24, sampleRate, true); // sample rate
      view.setUint32(28, sampleRate * 2, true); // byte rate (sampleRate * blockAlign)
      view.setUint16(32, 2, true); // block align (channels * bytesPerSample)
      view.setUint16(34, 16, true); // bits per sample
      writeString(view, 36, 'data');
      view.setUint32(40, sampleCount * 2, true);

      // Write samples
      for(let i=0;i<sampleCount;i++){
        let sample = 0;
        const t = i / sampleRate;
        for(const f of freqs){
          // simple sine + small envelope
          sample += Math.sin(2*Math.PI*f*t);
        }
        sample = sample / freqs.length; // normalize combined sine waves
        // apply simple linear fade-out
        const env = 1 - (i / sampleCount);
        const s = Math.max(-1, Math.min(1, sample * gain * env));
        const intSample = Math.floor(s * 0x7FFF);
        view.setInt16(44 + i*2, intSample, true);
      }

      // base64 encode
      const uint8 = new Uint8Array(buffer);
      let binary = '';
      const chunk = 0x8000;
      for (let i = 0; i < uint8.length; i += chunk) {
        binary += String.fromCharCode.apply(null, uint8.subarray(i, i + chunk));
      }
      return btoa(binary);
    }

    // create two distinct sounds:
    // positiveSound: short fanfare (stacked frequencies)
    // negativeSound: short "blip" or low negative tone
    function prepareEmbeddedSounds(){
      try{
        // fanfare-like: combine several harmonics for 0.45s
        const posBase64 = makeWavBase64([880, 1320, 1760], 0.45, 44100, 0.7);
        positiveSoundEl.src = 'data:audio/wav;base64,' + posBase64;

        // applause-like short effect: mix lower thud + short higher blip (0.5s)
        const negBase64 = makeWavBase64([220, 330], 0.35, 44100, 0.7);
        negativeSoundEl.src = 'data:audio/wav;base64,' + negBase64;

        // preload by loading small data URIs
        positiveSoundEl.load();
        negativeSoundEl.load();
      }catch(e){
        // if anything fails, leave src empty (we have mkBeep fallback)
        console.warn('Erro ao preparar sons embutidos:', e);
      }
    }

    // Firebase helpers
    async function nickExistsInDb(nick){
      try{
        const q = query(collection(db, SUBMISSIONS_COLLECTION), orderBy('timestamp','asc'));
        const snap = await getDocs(q);
        const lower = nick.toLowerCase();
        for(const d of snap.docs){ if(String(d.data().nick).toLowerCase()===lower) return true; }
      }catch(e){ console.warn('nickExistsInDb err', e); }
      const fallback = JSON.parse(localStorage.getItem('quiz_submissions_fallback')||'[]');
      for(const s of fallback){ if(String(s.nick).toLowerCase() === (nick.toLowerCase())) return true; }
      const played = JSON.parse(localStorage.getItem('quiz_played_nicks_v1')||'[]');
      if(played && Array.isArray(played)){
        if(played.some(p=> String(p).toLowerCase() === String(nick).toLowerCase())) return true;
      }
      return false;
    }

    async function saveSubmissionToDb(sub){
      try{ await addDoc(collection(db, SUBMISSIONS_COLLECTION), sub); return true; }catch(e){ console.error('save fail',e); return false; }
    }

    async function fetchAllSubmissions(){
      try{
        const q = query(collection(db, SUBMISSIONS_COLLECTION), orderBy('timestamp','asc'));
        const snap = await getDocs(q);
        return snap.docs.map(d=>({ id:d.id, ...d.data() }));
      }catch(e){ console.warn('fetchAllSubmissions err', e); return []; }
    }

    async function deleteSubmissionById(id){ if(!id) return; await deleteDoc(doc(db, SUBMISSIONS_COLLECTION, id)); }
    async function updateSubmissionById(id, data){ if(!id) return; await updateDoc(doc(db, SUBMISSIONS_COLLECTION, id), data); }

    // UI functions
    function showView(v){ loginView.style.display='none'; gameView.style.display='none'; resultsView.style.display='none'; if(v==='login') loginView.style.display='block'; if(v==='game') gameView.style.display='block'; if(v==='results') resultsView.style.display='block'; }
    function showLoginMessage(msg){ loginMsg.style.display='block'; loginMsg.textContent=msg }
    function hideLoginMessage(){ loginMsg.style.display='none'; loginMsg.textContent='' }

    startBtn.addEventListener('click', async ()=>{
      const nick = nickInput.value.trim();
      if(!nick){ showLoginMessage('Informe um nick válido.'); return; }

      // Admin shortcut
      if(nick === 'admin123'){
        const pass = prompt('Senha de admin:');
        if(pass === '123456'){
          isAdmin = true;
          adminArea.style.display='block';
          renderAdminPanel();
          currentUser = nick;
          nickBadge.textContent = currentUser;
          showView('results');
        } else {
          showLoginMessage('Senha de admin incorreta.');
        }
        return;
      }

      let exists = false;
      try{ exists = await nickExistsInDb(nick); }catch(e){ console.warn('Erro ao checar nick', e); }

      if(exists){
        showLoginMessage('Só é permitido jogar apenas uma Vez!');
        const viewBtn = document.createElement('button'); viewBtn.className='btn'; viewBtn.style.background='#6b2b8a'; viewBtn.style.color='#fff'; viewBtn.textContent='Ver Resultado!';
        viewBtn.onclick = ()=>{ renderResultsForNick(nick); showView('results'); };
        const existing = document.getElementById('viewResultInline'); if(existing) existing.remove(); viewBtn.id='viewResultInline'; loginView.appendChild(viewBtn);
        return;
      }

      // start
      currentUser = nick; nickBadge.textContent = currentUser; hideLoginMessage(); startCountdownBeforeGame();
    });

    viewResultsBtn.addEventListener('click', ()=>{ renderAllResults(); showView('results'); });

    // countdown before game
    function startCountdownBeforeGame(){ 
      showView('game'); 
      document.body.classList.add('countdown-blur');
      countdownBig.style.display='flex'; 
      let n=5; 
      countdownBig.textContent = n; 
      const intr=setInterval(()=>{
        n--;
        if(n>0) countdownBig.textContent = n;
        else if(n===0) countdownBig.textContent = 'Valendo!';
        else { 
          clearInterval(intr); 
          countdownBig.style.display='none';
          document.body.classList.remove('countdown-blur');
          beginGame(); 
        } 
      },900); 
    }

    function beginGame(){
      shuffled = [...characters];
      for(let i=shuffled.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]] }
      currentIndex=0; score=0; scoreEl.textContent=score; answerInput.value=''; gameStartTs = Date.now(); gameEndTs = null; showQuestion(currentIndex); answerInput.focus();
    }

    function showQuestion(idx){
      if(idx>=shuffled.length){ finishGame(); return; }
      const ch = shuffled[idx];
      charImg.src = ch.url;
      charImg.alt = ch.name;
      perQuestionRemaining = 30;
      questionTimerEl.textContent = perQuestionRemaining;
      if(perQuestionTimer) clearInterval(perQuestionTimer);
      perQuestionTimer = setInterval(()=>{
        perQuestionRemaining--;
        questionTimerEl.textContent = perQuestionRemaining;
        if(perQuestionRemaining<=0){
          clearInterval(perQuestionTimer);
          currentIndex++;
          setTimeout(()=>{ showQuestion(currentIndex); },400);
        }
      },1000);
    }

    function tryPlayAudio(el){
      try{
        if(el && el.src){
          el.currentTime = 0;
          const p = el.play();
          if(p && p.catch) p.catch(()=> { /* fallback */ });
          return true;
        }
      }catch(e){}
      return false;
    }

    function markWrong(){ 
      answerInput.classList.add('wrong'); 
      const played = tryPlayAudio(negativeSoundEl);
      if(!played) mkBeep(150,120);
      setTimeout(()=>answerInput.classList.remove('wrong'),700); 
    }

    function markCorrect(){ 
      answerInput.classList.remove('wrong'); 
      const played = tryPlayAudio(positiveSoundEl);
      if(!played) mkBeep(880,120);
    }

    submitAnswer.addEventListener('click', handleSubmit);
    answerInput && answerInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleSubmit(); });

    function handleSubmit(){
      if(currentIndex >= shuffled.length) return;
      const ans = normalizeAnswer(answerInput.value);
      const expected = normalizeAnswer(shuffled[currentIndex].name);
      if(!ans){ answerInput.classList.add('wrong'); setTimeout(()=>answerInput.classList.remove('wrong'),600); return; }
      if(ans === expected){
        score += 10; scoreEl.textContent = score; markCorrect();
        clearInterval(perQuestionTimer);
        answerInput.value='';
        currentIndex++;
        setTimeout(()=>{ showQuestion(currentIndex); },500);
      } else {
        markWrong();
        answerInput.value='';
      }
    }

    // finishGame agora mostra modal com dados e espera salvar
    function finishGame(){
      gameEndTs = Date.now();
      if(perQuestionTimer) clearInterval(perQuestionTimer);
      const totalTimeSec = Math.round((gameEndTs - gameStartTs)/1000);
      const submission = { nick: currentUser, score: score, timeSec: totalTimeSec, timestamp: Date.now() };

      pendingSubmission = submission;
      showSaveModal(submission);
    }

    function showSaveModal(sub){
      const d = new Date(sub.timestamp || Date.now());
      modalMeta.innerHTML = `
        <div>Nick: <strong>${escapeHtml(sub.nick)}</strong></div>
        <div>Pontos: <strong>${sub.score}</strong></div>
        <div>Tempo necessário: <strong>${sub.timeSec} s</strong></div>
        <div>Data / Hora: <strong>${formatDateTime(d)}</strong></div>
      `;
      saveModal.style.display = 'flex';
    }

    cancelSaveBtn.addEventListener('click', ()=>{
      saveModal.style.display = 'none';
      pendingSubmission = null;
      renderAllResults();
      showView('results');
    });

    confirmSaveBtn.addEventListener('click', async ()=>{
      if(!pendingSubmission) return;
      confirmSaveBtn.disabled = true;
      confirmSaveBtn.textContent = 'Salvando...';

      let saved = false;
      try{ saved = await saveSubmissionToDb(pendingSubmission); }catch(e){ console.warn('save error', e); saved = false; }

      if(!saved){
        const key = 'quiz_submissions_fallback';
        const arr = JSON.parse(localStorage.getItem(key)||'[]');
        arr.push(pendingSubmission);
        localStorage.setItem(key, JSON.stringify(arr));
      }

      // mark nick locally so it cannot play again
      const playedKey = 'quiz_played_nicks_v1';
      const played = JSON.parse(localStorage.getItem(playedKey)||'[]');
      played.push(pendingSubmission.nick);
      localStorage.setItem(playedKey, JSON.stringify(played));

      confirmSaveBtn.disabled = false;
      confirmSaveBtn.textContent = 'Salvar Resultado';
      saveModal.style.display = 'none';
      pendingSubmission = null;

      // AFTER saving, play fanfare sound to celebrate and render podium
      tryPlayAudio(positiveSoundEl) || mkBeep(880,180);
      // slight delay before showing results so sound plays smoothly
      setTimeout(()=>{ renderAllResults(); showView('results'); }, 220);

    });

    // Results & Admin
    async function renderAllResults(){
      let subs = [];
      try{ subs = await fetchAllSubmissions(); }catch(e){ subs = []; }

      const fallback = JSON.parse(localStorage.getItem('quiz_submissions_fallback')||'[]');
      subs = subs.concat(fallback.map(s=>({ id:null, ...s })));

      // podium sort: score desc, timestamp asc (tie-breaker only if score equal)
      const podiumSorted = [...subs].sort((a,b)=>{
        const scoreA = (a.score||0);
        const scoreB = (b.score||0);
        if(scoreB !== scoreA) return scoreB - scoreA; // higher score first
        return (a.timestamp||0) - (b.timestamp||0); // earlier timestamp wins on tie
      });

      // render podium
      podiumContainer.innerHTML = '';

      const first = podiumSorted[0] || null;
      const second = podiumSorted[1] || null;
      const third = podiumSorted[2] || null;

      const layout = [
        { data: second, cls: 'second', label: '2º' },
        { data: first, cls: 'first', label: '1º' },
        { data: third, cls: 'third', label: '3º' }
      ];

      layout.forEach((item)=>{
        const placeDiv = document.createElement('div');
        placeDiv.className = 'place ' + item.cls;
        if(item.data){
          placeDiv.innerHTML = `<div style="font-size:14px;font-weight:800">${item.label}</div><div class="championInner" style="margin-top:6px;font-weight:800">${escapeHtml(item.data.nick)}</div><div style="margin-top:6px;font-weight:700">${item.data.score} pts</div>`;
        } else {
          placeDiv.innerHTML = `<div style="font-size:14px;opacity:0.9">-</div>`;
        }
        podiumContainer.appendChild(placeDiv);
      });

      // list all submissions by chronological order
      allSubmissionsTbody.innerHTML = '';
      const byOrder = [...subs].sort((a,b)=>(a.timestamp||0) - (b.timestamp||0));
      byOrder.forEach((s, idx)=>{
        const tr = document.createElement('tr');
        const d = new Date(s.timestamp||Date.now());
        tr.innerHTML = `<td>${idx+1}</td><td>${escapeHtml(s.nick)}</td><td>${s.score}</td><td>${s.timeSec}</td><td>${formatDateTime(d)}</td><td></td>`;
        const actionsTd = tr.querySelector('td:last-child');

        if(isAdmin){
          const delBtn = document.createElement('button');
          delBtn.className = 'btn';
          delBtn.style.background = '#b31b1b';
          delBtn.textContent = 'Deletar';
          delBtn.onclick = async ()=>{
            if(!confirm('Deletar este envio?')) return;
            if(s.id){ 
              try{
                await deleteSubmissionById(s.id);
                // also remove this nick from local "played nicks" list (so it's freed locally)
                const playedKey = 'quiz_played_nicks_v1';
                const played = JSON.parse(localStorage.getItem(playedKey)||'[]');
                const filtered = played.filter(p => String(p).toLowerCase() !== String(s.nick).toLowerCase());
                localStorage.setItem(playedKey, JSON.stringify(filtered));
              }catch(e){
                console.error('Erro ao deletar remoto:', e);
                alert('Erro ao deletar registro remoto: ' + (e && e.message ? e.message : ''));
              }
            } else {
              const key = 'quiz_submissions_fallback';
              const arr = JSON.parse(localStorage.getItem(key)||'[]');
              const index = arr.findIndex(el => (el.nick === s.nick && String(el.timestamp) === String(s.timestamp)));
              if(index !== -1) arr.splice(index,1);
              localStorage.setItem(key, JSON.stringify(arr));

              // remove from played list too
              const playedKey = 'quiz_played_nicks_v1';
              const played = JSON.parse(localStorage.getItem(playedKey)||'[]');
              const filtered = played.filter(p => String(p).toLowerCase() !== String(s.nick).toLowerCase());
              localStorage.setItem(playedKey, JSON.stringify(filtered));
            }
            renderAllResults();
          };

          const editBtn = document.createElement('button');
          editBtn.className = 'btn';
          editBtn.style.background = '#6b2b8a';
          editBtn.textContent = 'Editar';
          editBtn.onclick = async ()=>{
            const oldNick = s.nick;
            const newNick = prompt('Nick:', s.nick);
            if(newNick === null) return;
            const newScore = parseInt(prompt('Pontuação:', s.score), 10);
            if(isNaN(newScore)) return alert('Pontuação inválida');
            const newTime = parseInt(prompt('Tempo (s):', s.timeSec), 10);
            if(isNaN(newTime)) return alert('Tempo inválido');
            const newTimestamp = s.timestamp || Date.now();
            const updated = { nick: newNick, score: newScore, timeSec: newTime, timestamp: newTimestamp };
            if(s.id){ 
              try{
                await updateSubmissionById(s.id, updated);
                // update local played list: replace oldNick occurrences with newNick
                const playedKey = 'quiz_played_nicks_v1';
                const played = JSON.parse(localStorage.getItem(playedKey)||'[]');
                const updatedPlayed = played.map(p => (String(p).toLowerCase() === String(oldNick).toLowerCase() ? newNick : p));
                localStorage.setItem(playedKey, JSON.stringify(updatedPlayed));
              }catch(e){
                console.error('Erro ao atualizar remoto:', e);
                alert('Erro ao atualizar registro remoto: ' + (e && e.message ? e.message : ''));
              }
            } else {
              const key = 'quiz_submissions_fallback';
              const arr = JSON.parse(localStorage.getItem(key)||'[]');
              const index = arr.findIndex(el => (el.nick === s.nick && String(el.timestamp) === String(s.timestamp)));
              if(index !== -1) arr[index] = updated;
              localStorage.setItem(key, JSON.stringify(arr));

              // update local played list: replace oldNick occurrences with newNick
              const playedKey = 'quiz_played_nicks_v1';
              const played = JSON.parse(localStorage.getItem(playedKey)||'[]');
              const updatedPlayed = played.map(p => (String(p).toLowerCase() === String(oldNick).toLowerCase() ? newNick : p));
              localStorage.setItem(playedKey, JSON.stringify(updatedPlayed));
            }
            renderAllResults();
          };

          const viewPodBtn = document.createElement('button');
          viewPodBtn.className = 'btn';
          viewPodBtn.style.background = '#333';
          viewPodBtn.textContent = 'Ver pódio';
          viewPodBtn.onclick = ()=>{ window.scrollTo({ top: 0, behavior: 'smooth' }); };

          actionsTd.appendChild(delBtn);
          actionsTd.appendChild(editBtn);
          actionsTd.appendChild(viewPodBtn);
        } else {
          actionsTd.innerHTML = '';
        }

        allSubmissionsTbody.appendChild(tr);
      });

      // show user's last result in userResultBox (if exists)
      if(currentUser){
        const found = byOrder.slice().reverse().find(s=> s.nick.toLowerCase() === currentUser.toLowerCase());
        if(found) showUserBox(found); else userResultBox.style.display='none';
      } else userResultBox.style.display='none';
    }

    function renderResultsForNick(nick){ renderAllResults(); showView('results'); }

    function showUserBox(sub){
      userResultBox.style.display = 'block';
      const d = new Date(sub.timestamp||Date.now());
      userResultBox.innerHTML = `<strong>Seu resultado</strong><div style="margin-top:6px">Nick: <strong>${escapeHtml(sub.nick)}</strong></div><div>Pontos: <strong>${sub.score}</strong></div><div>Tempo para realizar o questionário: <strong>${sub.timeSec} s</strong></div><div>Data / Hora do envio: <strong>${formatDateTime(d)}</strong></div>`;
    }

    // Admin functions
    async function renderAdminPanel(){ adminArea.style.display = 'block'; renderAllResults(); }
    adminRebootBtn.addEventListener('click', async ()=>{
      if(!confirm('Apagar TODOS os resultados do banco? Esta ação é irreversível.')) return;
      try{
        const all = await fetchAllSubmissions();
        for(const s of all){ if(s.id) await deleteSubmissionById(s.id); }
        // clear local fallback storage
        localStorage.removeItem('quiz_submissions_fallback');
        // <-- ADDED: also clear the played-nicks registry so nicks become reusable after reboot
        localStorage.removeItem('quiz_played_nicks_v1');
        alert('Todos os resultados apagados e cache local limpo.');
        renderAllResults();
      }catch(e){ alert('Erro ao apagar: ' + (e && e.message ? e.message : e)); }
    });
    adminViewPodiumBtn.addEventListener('click', ()=>{ window.scrollTo({ top: 0, behavior: 'smooth' }); });

    // Init
    (function init(){
      showView('login');
      characters.forEach(c=>{ const i = new Image(); i.src = c.url; });
      // prepare embedded base64 sounds
      prepareEmbeddedSounds();
      // attempt to show any locally-saved submissions in results
      renderAllResults();
    })();

    // prevent accidental reload during game
    window.addEventListener('beforeunload', (e)=>{
      if(gameStartTs && !gameEndTs){
        e.preventDefault();
        e.returnValue = 'Se você sair agora perderá seu progresso.';
      }
    });

    // realtime update attempt (if allowed by rules)
    try{
      const qAll = query(collection(db, SUBMISSIONS_COLLECTION), orderBy('timestamp','asc'));
      onSnapshot(qAll, ()=>{ if(document.body.contains(allSubmissionsTbody)) renderAllResults(); });
    }catch(e){ /* ignore if cannot subscribe */ }

  </script>
</body>
</html>
